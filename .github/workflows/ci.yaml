name: Test And Sync
on:
  push:
  pull_request:
  workflow_call:
    inputs:
      CallerPackage:
        description: 'The package to call the workflow'
        required: true
        type: string
      TopBranch:
        description: 'The branch of the main repository'
        required: false
        default: 'main'
        type: string

env:
  PRJ_REPO: "TestForStarry/MainRepoB"

jobs:
  clippy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: 
        rust-toolchain: [nightly]

    steps:
    - uses: actions/checkout@v4
      if: inputs.CallerPackage == ''
    - uses: actions/checkout@v4
      with:
        repository: Starry-OS/Starry
    - uses: actions/checkout@v4
      if: inputs.CallerPackage != ''
      with:
        repository: ${{ env.PRJ_REPO }}
        ref: ${{ inputs.TopBranch }}
    - name: Update version for external test
      if: inputs.CallerPackage != ''
      run: |
        cargo install dependencies-patch
        dependencies-patch -c . -n ${{ inputs.CallerPackage }} -t git --git-repo ${{ github.repository }} --commit ${{ github.sha }}
    - uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.rust-toolchain }}
        components: rust-src, clippy, rustfmt
    - name: Clippy for the default target
      run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: 
        rust-toolchain: [nightly]
    steps:
    - uses: actions/checkout@v4
      if: inputs.CallerPackage == ''
    - uses: actions/checkout@v4
      if: inputs.CallerPackage != ''
      with:
        repository: ${{ env.PRJ_REPO }}
        ref: ${{ inputs.TopBranch }}
    - name: Update version for external test
      if: inputs.CallerPackage != ''
      run: |
        cargo install dependencies-patch
        dependencies-patch -c . -n ${{ inputs.CallerPackage }} -t git --git-repo ${{ github.repository }} --commit ${{ github.sha }}

    - uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.rust-toolchain }}
        components: rust-src, clippy, rustfmt
    - name: Test for the default target
      run: cargo run
  